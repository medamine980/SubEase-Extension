(()=>{"use strict";const e="authToken",t="lastAuthTokenVerification",a="userCache",n="favoriteLanguage",o="autoSync",s="remainingDownloads",i={USER_AGENT_HEADER:"subease v0.1.2",VERIFICATION_HOURS_GAP_IN_MS:144e5,SUPPORTED_LANGUAGES:[{lang:"all languages",code:""},{lang:"english",code:"en"},{lang:"french",code:"fr"},{lang:"deutsch",code:"de"}]},d="2qsRn5gCOQ6v0Ddd97aZbad9xUuO0SVd",l=document.querySelector("[data-about-us-btn]"),c=document.querySelector("[data-user-btn]"),r=document.querySelector("[data-about-us-dialog]"),u=document.querySelector("[data-settings-btn]"),m=document.querySelector("[data-settings-dialog]"),g=document.querySelector("[data-user-dialog]"),h=g.querySelector("[data-allowed-downloads-modal]"),_=g.querySelector("[data-level]"),v=g.querySelector("[data-username-modal]"),p=g.querySelector("[data-logout-btn]"),w=document.querySelector("[data-remaining-downloads]"),y=document.querySelector("[data-autosync-checkbox]"),E=document.querySelector("[data-select-lang]"),L=document.querySelector("[data-radar]");document.querySelector("[data-loading-prog]");let S,f;new BroadcastChannel("login").onmessage=async e=>{const{data:t}=e,{type:a}=t;if("logged-in-successfully"===a){const{token:e}=t;f=void 0,C(),await k(e)}C()},chrome.tabs.query({active:!0,currentWindow:!0},(function(e){S=e[0];const t=document.querySelector("[data-videos-list]"),a=chrome.tabs.connect(S.id,{name:"subtitles"});let n,o=0;n=setInterval((()=>{if(2===o){if(0===t.childElementCount){const e=document.createElement("li");e.classList.add("videos-list__item-msg"),e.textContent="No videos are found",t.id="not-found-item",t.appendChild(e),t.ariaBusy=!1}return L.remove(),clearInterval(n)}o++,a.postMessage({type:"initial"})}),400);let s=[];a.onMessage.addListener((function(e){if("initial"===e.type){const{id:n,platform:o,videosLength:i,videosTitle:d,activatedVideos:l,icon:c}=e;if(0===i||s.find((({id:e})=>e==e)))return;s.push({id:n,videosLength:i}),document.querySelector("#not-found-item")?.remove();for(let e=0;e<i;e++){const s=document.createElement("li"),i=document.createElement("img");i.src=c??"../images/any-video.png",i.width=32,i.height=32;const r=document.createElement("div"),u=document.createElement("h3");let m;u.textContent=d[e],u.classList.add("videos-list__item__title"),u.title=d[e],l[e]&&(m=document.createElement("span"),m.innerHTML="&#x2713;",m.classList.add("videos-list__item__checkmark"),m.dataset.checkmark=!0);const g=document.createElement("p");g.textContent=`platform: ${o}`,r.append(u,g),s.classList.add("videos-list__item"),s.dataset.video=e,s.dataset.id=n,s.addEventListener("mouseover",(t=>{a.postMessage({type:"videoHover",id:n,videoIndex:e})})),s.addEventListener("mouseout",(t=>{a.postMessage({type:"removeVideoHover",id:n,videoIndex:e})})),s.addEventListener("click",(t=>{if(a.postMessage({type:"videoChosen",id:n,videoIndex:e}),!s.querySelector("[data-checkmark]")){const e=document.createElement("span");e.innerHTML="&#x2713;",e.classList.add("videos-list__item__checkmark"),e.dataset.checkmark=!0,s.append(e)}window.close()})),m&&s.append(m),s.append(i,r),t.appendChild(s)}}}))})),l.addEventListener("click",(e=>{r.showModal(),r.querySelector("a").blur()})),u.addEventListener("click",(e=>{m.showModal()})),chrome.storage.local.get([e,t,a]).then((async({[e]:n,[t]:o,[a]:s})=>{null!=n?s&&o&&Date.now()-o<=i.VERIFICATION_HOURS_GAP_IN_MS?f=s:await k(n):f={},C()}));const k=async n=>{const o=await fetch("https://api.opensubtitles.com/api/v1/infos/user",{headers:{"Api-Key":d,Authorization:`Bearer ${n}`,"X-User-Agent":i.USER_AGENT_HEADER}});if(200===o.status){const e=await o.json();f=e.data,await chrome.storage.local.set({[t]:Date.now(),[a]:e.data})}else 503===o.status?f=null:(f={},await chrome.storage.local.remove(e))};function b(){chrome.windows.create({url:chrome.runtime.getURL("views/login/login.html"),height:screen.height,width:screen.width/2,left:parseInt(screen.width/4),top:0,type:"popup"})}function C(){if(void 0===f){const e=document.createElement("progress");e.classList.add("navbar__container__list__item__user-prog"),c.textContent="",c.appendChild(e),c.classList.remove("navbar__container__list__item--red"),c.onclick=null}else if(null===f)c.textContent="Error",c.classList.add("navbar__container__list__item--red"),c.onclick=()=>{alert("Error: please reload the extension")};else if(0===Object.keys(f).length)c.textContent="Login",c.classList.remove("navbar__container__list__item--red"),c.onclick=b;else{const t=document.createElement("img");t.width=12,t.src="../../images/user.png",t.alt="user",c.classList.remove("navbar__container__list__item--red"),c.textContent="",c.appendChild(t),v.innerHTML=`Username: <strong>${f.username}</strong>`,_.innerHTML=`Level: <strong>${f.level}</strong>`,h.innerHTML=`Remaining downloads: <strong>${f.remaining_downloads}/${f.allowed_downloads}</strong>`,c.onclick=()=>{g.showModal()},(async e=>{await chrome.storage.local.set({[s]:e})})(f.remaining_downloads),p.onclick=async()=>{f={},await chrome.storage.local.remove(e),g.close(),C()}}}function q(e){e<10?(w.classList.remove("remaining-downloads--high"),w.classList.add("remaining-downloads--low")):(w.classList.add("remaining-downloads--high"),w.classList.remove("remaining-downloads--low")),w.textContent=e}window.addEventListener("click",(e=>{e.target===r?r.close():e.target===m?m.close():e.target===g&&g.close()})),chrome.storage.onChanged.addListener(((e,t)=>{for(let[a,{oldValue:n,newValue:o}]of Object.entries(e))"local"===t&&a===s&&q(o)})),(e=>{let t=new DocumentFragment;for(let e=0;e<i.SUPPORTED_LANGUAGES.length;e++){const{lang:a,code:n}=i.SUPPORTED_LANGUAGES[e],o=document.createElement("option");o.text=a,o.value=n,0===e&&(o.selected=!0),t.appendChild(o)}e.appendChild(t)})(E),chrome.storage.local.get([o,n,s]).then((({[o]:e,[n]:t,[s]:a})=>{y.checked=e??!0,null==e&&chrome.storage.local.set({[o]:!0}),E.value=t??i.SUPPORTED_LANGUAGES[0].code,a||(w.title="Download at least one subtitle."),q(a??"???")})),y.addEventListener("change",(async e=>{await chrome.storage.local.set({[o]:e.currentTarget.checked})})),E.addEventListener("change",(async()=>{chrome.storage.local.set({[n]:E.value})}))})();
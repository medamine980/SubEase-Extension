(()=>{"use strict";const e={AUTH_TOKEN_KEY:"authToken",LAST_AUTH_TOKEN_VERIFICATION:"lastAuthTokenVerification",USER_CACHE:"userCache",FAVORITE_LANGUAGE:"favoriteLanguage",AUTO_SYNC:"autoSync",REMAINING_DOWNLOADS:"remainingDownloads"},t={USER_AGENT_HEADER:"subease v0.1.2",VERIFICATION_HOURS_GAP_IN_MS:144e5,SUPPORTED_LANGUAGES:[{lang:"all languages",code:""},{lang:"english",code:"en"},{lang:"french",code:"fr"},{lang:"deutsch",code:"de"}]},n=async t=>{await chrome.storage.local.set({[e.REMAINING_DOWNLOADS]:t})};class a{static port;constructor(e,t,n){a.port||("to-tab"===t?a.port=chrome.tabs.connect(n.id,{name:e}):"to-background"===t&&(a.port=chrome.runtime.connect({name:e})))}postMessage(e){a.port.postMessage(e)}addMessageListener(e){a.port.onMessage.addListener(e)}onDisconnect(e){a.port.onDisconnect.addListener(e)}}const o=document.querySelector("[data-middle]"),s=document.querySelector("[data-search-input]"),r=document.querySelector("[data-autocomplete-options]"),c=document.querySelector("[data-lang-selector]"),d=document.querySelector("[data-is-hearing-impaired]"),i=document.querySelector("[data-close-btn]"),l=document.querySelector("[data-search-info-message]"),u=40;let p;const m=decodeURIComponent(location.search).split("&"),h=m[0].match(/=(.+)/)[1],g=m[1].match(/=(.+)/)[1],E=m[2]?.match(/=(.+)/)?.[1]??"";let _,v=m[3]?.match(/=(.+)/)[1];function A(){if(l.classList.remove("show"),_)o.contains(_)||o.appendChild(_);else{_=document.createElement("div"),_.classList.add("loading-container");const e=document.createElement("progress");e.classList.add("loading-container__progress"),e.dataset.loadingEle=!0,_.append(e),o.appendChild(_)}}function f(){const e=document.createElement("div");e.classList.add("download-overlay-container");const t=document.createElement("p");return t.textContent="Downloading",t.classList.add("download-overlay-container__text"),e.appendChild(t),document.body.appendChild(e),e}async function T(e){const n=p;e=encodeURIComponent(e);const o=encodeURIComponent(c.value),i=d.checked?"only":"include",m=new Request(`https://api.opensubtitles.com/api/v1/subtitles?query=${e}&languages=${o}&hearing_imapired=${i}`,{method:"GET",headers:{"Api-Key":"2qsRn5gCOQ6v0Ddd97aZbad9xUuO0SVd","X-User-Agent":t.USER_AGENT_HEADER}}),E=await fetch(m);if(E.status>=500)return _.remove(),l.textContent="Error at the server level",void l.classList.add("show");if(n!==p)return;const A=await E.json();if(r.textContent="",A.errors||0===A.data.length)return _?.remove(),"Query is too short"===A.errors?.[0]?l.textContent="Try typing more characters":l.textContent="Not found",void l.classList.add("show");const T=A.data.length>u?u:A.data.length,C=new DocumentFragment;for(let e=0;e<T;e++){const{id:t,attributes:{files:[{file_id:n}],fps:c,language:d,feature_details:{movie_name:i}}}=A.data[e],l=document.createElement("li"),u=document.createElement("span"),p=document.createElement("span");u.classList.add("autocomplete-options__option__lang"),l.classList.add("autocomplete-options__option"),l.id=t,u.textContent=d,p.textContent=i,l.append(u,p),l.addEventListener("click",(async e=>{const t=f();let d;try{d=await S(n)}catch{return void t.remove()}let i=y(d);chrome.tabs.getCurrent((e=>{new a("searchIframe","to-tab",e).postMessage({id:h,videoIndex:g,type:"addTrack",webvtt:i,syncValue:v,lang:o,fps:c}),s.value=""})),t.remove(),r.textContent=""})),C.appendChild(l)}r.appendChild(C),r.scrollTo({top:0}),_.remove()}function y(e){var t=function(e){var t=e.replace(/\r+/g,"");t=t.replace(/^\s+|\s+$/g,"");var n=t.split("\n\n"),a="";if(n.length>0){a+="WEBVTT\n\n";for(var o=0;o<n.length;o+=1)a+=C(n[o])}return a}(e);return t}function C(e){for(var t="",n=e.split(/\n/);n.length>3;){for(var a=3;a<n.length;a++)n[2]+="\n"+n[a];n.splice(3,n.length-3)}var o=0;if(!n[0].match(/\d+:\d+:\d+/)&&n[1].match(/\d+:\d+:\d+/)&&(t+=n[0].match(/\w+/)+"\n",o+=1),!n[o].match(/\d+:\d+:\d+/))return"";var s=n[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);return s?(t+=s[1]+":"+s[2]+":"+s[3]+"."+s[4]+" --\x3e "+s[5]+":"+s[6]+":"+s[7]+"."+s[8]+"\n",n[o+=1]&&(t+=n[o]+"\n\n"),t):""}s.value=E,E&&T(s.value).then((()=>{s.focus(),s.select()})),v&&(v=parseInt(v)),i.addEventListener("click",(e=>{chrome.tabs.getCurrent((e=>{new a("searchIframe","to-tab",e).postMessage({id:h,videoIndex:g,type:"closeSearchSubtitles"})}))})),window.addEventListener("message",(e=>{const t=e.data;"sync"===t.type?v=t.syncValue:"scrollIntoInput"===t.type&&s.scrollIntoView({behavior:"smooth",block:"center"})})),(e=>{let n=new DocumentFragment;for(let e=0;e<t.SUPPORTED_LANGUAGES.length;e++){const{lang:a,code:o}=t.SUPPORTED_LANGUAGES[e],s=document.createElement("option");s.text=a,s.value=o,0===e&&(s.selected=!0),n.appendChild(s)}e.appendChild(n)})(c),chrome.storage.local.get([e.FAVORITE_LANGUAGE]).then((({[e.FAVORITE_LANGUAGE]:t})=>{t&&(c.value=t)})),d.addEventListener("change",(async e=>{""!==s.value&&(A(),await T(s.value))})),c.addEventListener("change",(async e=>{""!==s.value&&(A(),await T(s.value))})),s.addEventListener("input",(async e=>{e.preventDefault(),A(),function(e=s.value){clearTimeout(p),p=setTimeout((async()=>{await T(e)}),250)}()})),s.addEventListener("keypress",(async e=>{clearTimeout(p),"Enter"===e.key&&(e.preventDefault(),A(),await T(s.value))}));const w={};async function S(a){if(w[a])return w[a].srt;const o={"Content-Type":"application/json","Api-Key":"2qsRn5gCOQ6v0Ddd97aZbad9xUuO0SVd","X-User-Agent":t.USER_AGENT_HEADER},{[e.AUTH_TOKEN_KEY]:s,[e.LAST_AUTH_TOKEN_VERIFICATION]:r}=await chrome.storage.local.get([e.AUTH_TOKEN_KEY,e.LAST_AUTH_TOKEN_VERIFICATION]);s&&Date.now()-r<=t.VERIFICATION_HOURS_GAP_IN_MS&&(o.Authorization="Bearer "+s);const c=new Request("https://api.opensubtitles.com/api/v1/download",{method:"POST",body:JSON.stringify({file_id:a}),headers:o});let d=await fetch(c);const i=await d.json();if(!i.error){let{remaining:t}=i;if(t-=1,o.Authorization){const{[e.USER_CACHE]:n}=await chrome.storage.local.get(e.USER_CACHE);n.remaining_downloads=t,await chrome.storage.local.set({[e.USER_CACHE]:n})}await n(t);const{link:s}=i;d=await fetch(s);const r=await d.text();return w[a]={link:s,srt:r},r}}})();
(()=>{"use strict";class e{static port;constructor(t,n,a){e.port||("to-tab"===n?e.port=chrome.tabs.connect(a.id,{name:t}):"to-background"===n&&(e.port=chrome.runtime.connect({name:t})))}postMessage(t){e.port.postMessage(t)}addMessageListener(t){e.port.onMessage.addListener(t)}}const t=document.querySelector("[data-middle]"),n=document.querySelector("[data-search-input]"),a=document.querySelector("[data-autocomplete-options]"),o=document.querySelector("[data-lang-selector]"),s=document.querySelector("[data-is-hearing-impaired]"),r=document.querySelector("[data-close-btn]"),c=document.querySelector("[data-search-info-message]"),d=40;let i;const l=decodeURIComponent(location.search).split("&"),u=l[0].match(/=(.+)/)[1],p=l[1].match(/=(.+)/)[1],m=l[2]?.match(/=(.+)/)?.[1]??"";let h,v=l[3]?.match(/=(.+)/)[1];function g(){if(c.classList.remove("show"),h)t.contains(h)||t.appendChild(h);else{h=document.createElement("div"),h.classList.add("loading-container");const e=document.createElement("progress");e.classList.add("loading-container__progress"),e.dataset.loadingEle=!0,h.append(e),t.appendChild(h)}}function y(){const e=document.createElement("div");e.classList.add("download-overlay-container");const t=document.createElement("p");return t.textContent="Downloading",t.classList.add("download-overlay-container__text"),e.appendChild(t),document.body.appendChild(e),e}async function f(t){const r=i;t=encodeURIComponent(t);const l=encodeURIComponent(o.value),m=s.checked?"only":"include",g=new Request(`https://api.opensubtitles.com/api/v1/subtitles?query=${t}&languages=${l}&hearing_imapired=${m}`,{method:"GET",headers:{"Api-Key":"2qsRn5gCOQ6v0Ddd97aZbad9xUuO0SVd"}}),f=await fetch(g);if(f.status>=500)return h.remove(),c.textContent="Error at the server level",void c.classList.add("show");if(r!==i)return;const C=await f.json();if(a.textContent="",C.errors||0===C.data.length)return h?.remove(),"Query is too short"===C.errors?.[0]?c.textContent="Try typing more characters":c.textContent="Not found",void c.classList.add("show");const b=C.data.length>d?d:C.data.length,L=new DocumentFragment;for(let t=0;t<b;t++){const{id:o,attributes:{files:[{file_id:s}],fps:r,language:c,feature_details:{movie_name:d}}}=C.data[t],i=document.createElement("li"),m=document.createElement("span"),h=document.createElement("span");m.classList.add("autocomplete-options__option__lang"),i.classList.add("autocomplete-options__option"),i.id=o,m.textContent=c,h.textContent=d,i.append(m,h),i.addEventListener("click",(async t=>{const o=y();let c;try{c=await E(s)}catch{return void o.remove()}let d=w(c);chrome.tabs.getCurrent((t=>{new e("searchIframe","to-tab",t).postMessage({id:u,videoIndex:p,type:"addTrack",webvtt:d,syncValue:v,lang:l,fps:r}),n.value=""})),o.remove(),a.textContent=""})),L.appendChild(i)}a.appendChild(L),a.scrollTo({top:0}),h.remove()}function w(e){var t=function(e){var t=e.replace(/\r+/g,"");t=t.replace(/^\s+|\s+$/g,"");var n=t.split("\n\n"),a="";if(n.length>0){a+="WEBVTT\n\n";for(var o=0;o<n.length;o+=1)a+=C(n[o])}return a}(e);return t}function C(e){for(var t="",n=e.split(/\n/);n.length>3;){for(var a=3;a<n.length;a++)n[2]+="\n"+n[a];n.splice(3,n.length-3)}var o=0;if(!n[0].match(/\d+:\d+:\d+/)&&n[1].match(/\d+:\d+:\d+/)&&(t+=n[0].match(/\w+/)+"\n",o+=1),!n[o].match(/\d+:\d+:\d+/))return"";var s=n[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);return s?(t+=s[1]+":"+s[2]+":"+s[3]+"."+s[4]+" --\x3e "+s[5]+":"+s[6]+":"+s[7]+"."+s[8]+"\n",n[o+=1]&&(t+=n[o]+"\n\n"),t):""}n.value=m,m&&f(n.value).then((()=>{n.focus(),n.select()})),v&&(v=parseInt(v)),r.addEventListener("click",(t=>{chrome.tabs.getCurrent((t=>{new e("searchIframe","to-tab",t).postMessage({id:u,videoIndex:p,type:"closeSearchSubtitles"})}))})),window.addEventListener("message",(e=>{const t=e.data;"sync"===t.type?v=t.syncValue:"scrollIntoInput"===t.type&&n.scrollIntoView({behavior:"smooth",block:"center"})})),s.addEventListener("change",(async e=>{""!==n.value&&(g(),await f(n.value))})),o.addEventListener("change",(async e=>{""!==n.value&&(g(),await f(n.value))})),n.addEventListener("input",(async e=>{e.preventDefault(),g(),function(e=n.value){clearTimeout(i),i=setTimeout((async()=>{await f(e)}),250)}()})),n.addEventListener("keypress",(async e=>{clearTimeout(i),"Enter"===e.key&&(e.preventDefault(),g(),await f(n.value))}));const b={};async function E(e){if(b[e])return b[e].srt;const t=new Request("https://api.opensubtitles.com/api/v1/download",{method:"POST",body:JSON.stringify({file_id:e}),headers:{"Content-Type":"application/json","Api-Key":"2qsRn5gCOQ6v0Ddd97aZbad9xUuO0SVd"}});let n=await fetch(t);const a=await n.json();if(!a.error){const{link:t}=a;n=await fetch(t);const o=await n.text();return b[e]={link:t,srt:o},o}console.error(a)}})();
(()=>{"use strict";const e="autoSync",t="element",n="track",o="fps";let l,s={},i={},c=[],r={};const d=btoa(1e3*Math.random())+btoa(Date.now()),a=500;function u(){const{href:e}=location,t=e.match(/https?:\/\/(?:www\.)?([A-Za-z0-9]+)\..+/)?.[1];return t.charAt(0).toLocaleUpperCase()+t.slice(1)}function y(e){const t=u();return document.querySelector("title")?.text??t}function p(e,t,n){const o=new Date(`1970-01-01T${e}Z`);if(o.setSeconds((o.getSeconds()+t)/n),o.getDay()<4)return"00:00:00.000";if(o.getDay()>4)return"99:59:59.999";return`${o.getHours().toString().replace(/^(\d)$/,"0$1")}:${o.getMinutes().toString().replace(/^(\d)$/,"0$1")}:${o.getSeconds().toString().replace(/^(\d)$/,"0$1")}.${o.getMilliseconds().toString().padEnd("3","0")}`}function m(e,t,n=1){const o=e.split("\n\n"),l=/([0-9]{2}:[0-9]{2}:[0-9]{2}(?:.\d+)?)/g,s=[];return o.forEach((e=>{const o=e.match(l);if(!o)return s.push(e);{let l=[],i=!0;for(let e=0;e<o.length;e++){const s=p(o[e],t,n);if("00:00:00.000"===s&&0===e&&(i=!1),"00:00:00.000"===s&&1===e)return;if("99:59:59.999"===s&&1===e&&!i)return;l.push(s)}s.push(e.replace(/([0-9]{2}:[0-9]{2}:[0-9]{2}(?:.\d+)?) --> ([0-9]{2}:[0-9]{2}:[0-9]{2}(?:.\d+)?)/,l.join(" --\x3e ")))}})),s.join("\n\n")}function f(e){const{videoIndex:n,id:o}=e,l=s[n]?.[t];if(o===d&&l){let e=document.querySelector(`[id="frameId${o+n}"]`),{width:t,height:s,top:i,left:r}=l.getBoundingClientRect();if(e)e.style.height=`${s}px`,e.style.width=`${t}px`,e.style.left=`${r+scrollX}px`,e.style.top=`${i+scrollY}px`,"none"===e.style.display?(e.style.display="block",c[n]&&e.contentWindow.postMessage({type:"sync",syncValue:c[n]},chrome.runtime.getURL("/*")),e.contentWindow.postMessage({type:"scrollIntoInput"},chrome.runtime.getURL("/*"))):e.style.display="none";else{const d=encodeURIComponent(o),p=encodeURIComponent(n),m=y(),f=encodeURIComponent(m!==u()?m.substring(0,25):"");let g;e=document.createElement("iframe"),e.style.zIndex=2147483647,e.style.position="absolute",e.id=`frameId${o+n}`,e.style.height=`${s}px`,e.style.width=`${t}px`,e.style.left=`${r+scrollX}px`,e.style.top=`${i+scrollY}px`,e.style.boxSizing="border-box",e.src=chrome.runtime.getURL(`views/search/index.html?callerId=${d}&videoId=${p}&searchTitle=${f}${c[n]?` & syncValue=${c[n]}`:""}`),document.body.prepend(e),window.addEventListener("resize",(t=>{clearTimeout(g),g=setTimeout((()=>{const{width:t,height:n,top:o,left:s}=l.getBoundingClientRect();e.style.height=`${n}px`,e.style.width=`${t}px`,e.style.left=`${s+scrollX}px`,e.style.top=`${o+scrollY}px`}),a)})),e.contentWindow.postMessage({type:"scrollIntoInput"})}}}function g(e,n,o){const{id:l,videoIndex:i}=e,c=document.querySelector(`[id="frameId${l+i}"]`),r=s[i][t],d=document.createElement("p"),u=document.createElement("span");u.textContent=n,u.style.marginLeft="auto";const y=document.createElement("span");let p;function m(){clearTimeout(p),p=setTimeout((()=>{const{width:e,top:t,left:n}=r.getBoundingClientRect();d.style.width=`${e}px`,d.style.left=`${n+scrollX}px`,d.style.top=`${t+scrollY}px`}),a)}function f(){d.remove(),window.removeEventListener("resize",m)}y.innerHTML="&times;",y.style.fontWeight="bold",y.style.marginLeft="auto",y.style.fontSize="1.3em",y.style.cursor="pointer",y.onclick=f,d.style.cssText=c.style.cssText,d.style.display="block",d.style.fontSize="16px",d.style.padding="10px",d.style.height="auto",d.style.display="flex",d.style.justifyContent="center",d.style.alignItems="center",d.style.textAlign="center",d.style.color="white",d.style.backgroundColor=o?"#d70000":"#067500",d.append(u,y),window.addEventListener("resize",m),setTimeout((()=>{f()}),5e3),c.insertAdjacentElement("afterend",d)}function h(e,o){const{id:l,videoIndex:i}=e,c=s[i]?.[t];if(l!==d||!c)return;const r=document.querySelector(`[id="frameId${l+i}"]`);let u=document.querySelector(`[id="floatingBtnId${l+i}"]`);if(!u){u=document.createElement("button");const{right:y,top:p}=c.getBoundingClientRect();u.id=`floatingBtnId${l+i}`,u.style.cssText=r.style.cssText,u.style.left=y+scrollX-10+"px",u.style.top=`${p+scrollY+10}px`,u.style.width="auto",u.style.height="auto",document.fullscreenElement&&(u.style.display="none");const m=document.createElement("span"),f=document.createElement("img");let g;function h(){let e=document.querySelector(`[id='settingsIframeId${l+i}']`);if(!e){const{left:t,width:o,top:d}=u.getBoundingClientRect();e=document.createElement("iframe"),e.id=`settingsIframeId${l+i}`;const y=encodeURIComponent(l),p=encodeURIComponent(i);let m;e.src=chrome.runtime.getURL(`views/settings/index.html?callerId=${y}&videoIndex=${p}&isTrackAdded=${Boolean(s[i][n])}&downloadLink=${c.src??""}`),e.style.zIndex=2147483647,e.style.position="absolute",e.style.width="400px",e.style.left=t-400+scrollX-5+"px",e.style.top=`${d+scrollY}px`,e.style.borderRadius="1em",e.style.height="250px",window.addEventListener("resize",(t=>{clearTimeout(m),setTimeout((()=>{const{left:t,width:n,top:o}=u.getBoundingClientRect();e.style.width="400px",e.style.left=t-400+scrollX-5+"px",e.style.top=`${o+scrollY}px`}),a)})),r.insertAdjacentElement("afterend",e)}if("block"===e.style.display)e.style.display="none";else{const{left:t,top:n}=u.getBoundingClientRect();e.style.left=t-400+scrollX-5+"px",e.style.top=`${n+scrollY}px`,e.style.display="block"}}f.src=chrome.runtime.getURL("icons/icon128.png"),f.width=28,f.style.verticalAlign="middle",u.append(f),u.append(m),window.addEventListener("resize",(e=>{clearTimeout(g),g=setTimeout((()=>{const{right:e,top:t}=c.getBoundingClientRect();u.style.left=e+scrollX-10+"px",u.style.top=`${t+scrollY+10}px`}),a)})),window.addEventListener("fullscreenchange",(()=>{document.fullscreenElement?u.style.display="none":u.style.display="block"})),r.insertAdjacentElement("beforebegin",u),window.addEventListener("click",(e=>{if(!u.contains(e.target)){let e=document.querySelector(`[id='settingsIframeId${l+i}']`);e&&(e.style.display="none")}})),u.onclick=h}o&&(r.style.display="none")}chrome.runtime.onConnect.addListener((function(p){p.onMessage.addListener((async function(x){if("subtitles"===p.name){const{type:e}=x;if("initial"===e){let e;const n=document.querySelector("link[rel*='icon']")?.href;if(l||!1===l)l&&(e=l);else try{e=URL.createObjectURL(await(await fetch(n??"/favicon.ico")).blob()),l=e}catch{l=!1}Array.from(document.querySelectorAll("video")).forEach(((e,n)=>{s[n]||(s[n]={[t]:e})}));let o=[];for(let e in s)o[e]=y(s[e][t]);p.postMessage({id:d,type:"initial",platform:u(),videosTitle:o,activatedVideos:r,videosLength:Object.keys(s).length,icon:e})}else if("videoHover"===e){const{videoIndex:e,id:n}=x;if(n!==d||!s[e])return;const{width:o,height:l,top:i,left:c}=s[e][t].getBoundingClientRect();let r=document.querySelector(`[id="${n+e}"]`);r||(r=document.createElement("div"),r.id=n+e,document.body.appendChild(r),r.style.zIndex=2147483647,r.style.position="absolute",r.style.pointerEvents="none"),r.style.height=`${l}px`,r.style.width=`${o}px`,r.style.left=`${c+scrollX}px`,r.style.top=`${i+scrollY}px`,r.style.backgroundColor="#0098ff55",r.scrollIntoView({behavior:"smooth",block:"center"})}else if("removeVideoHover"===e){const{videoIndex:e,id:t}=x;let n=document.querySelector(`[id="${t+e}"]`);n&&(n.style.backgroundColor="transparent")}else if("videoChosen"===e){const{videoIndex:e}=x;r[e]=!0,f(x),h(x,!1),await async function(e){let t=document.querySelector(`[id="styleId${e}"]`);if(!t){t=document.createElement("style"),t.id=e;const n=await chrome.storage.local.get(["textColor","bgColor"]);t.textContent=`::cue{\n            background-color: var(--track-bg-color, ${n.bgColor??"black"});\n            color: var(--track-text-color, ${n.textColor??"white"});\n        }`,document.head.appendChild(t)}return t}()}}else if("searchIframe"===p.name){if("addTrack"===x.type){let{id:l,videoIndex:c,webvtt:r,syncValue:u=0,lang:y,fps:p}=x;if(l!==d||!s[c])return;const f=s[c][t];s[c][n]=r,h(x,!0);const $=(await chrome.storage.local.get([e]))[e];if(!s[c][o]&&$){const e=function(e,t){let n=document.querySelector(`[id="autoSyncOverlay${e}"`);if(!n){let o;function l(){clearTimeout(o),o=setTimeout((()=>{const{top:e,left:o,width:l,height:s}=t.getBoundingClientRect();n.style.top=`${e+scrollY}px`,n.style.left=`${o+scrollX}px`,n.style.width=`${l}px`,n.style.height=`${s}px`}),a)}n=document.createElement("div"),n.id="autoSyncOverlay"+e;const{top:s,left:i,width:c,height:r}=t.getBoundingClientRect();n.style.position="absolute",n.style.top=`${s+scrollY}px`,n.style.left=`${i+scrollX}px`,n.style.width=`${c}px`,n.style.height=`${r}px`,n.style.display="grid",n.style.placeItems="center",n.style.fontSize="36px",n.style.color="white";const d=document.createElement("p");d.textContent="Auto Syncing";const u=document.createElement("progress");u.style.width="4em",u.max="100",n.append(d,u),n.style.backgroundColor="#5559",n.style.zIndex=2147483647,window.addEventListener("resize",l),document.body.prepend(n)}return n.style.display="grid",n}(l+c,f);s[c][o]=await function(e,t,n){let o,l,s,c=!1,r=0,d=[];return e.muted=!0,new Promise((a=>{function u(){d.pop(),c=!0}e.addEventListener("seeked",u),i[t]=e.requestVideoFrameCallback((function y(p,m){if(r>=5)return s=d.reduce(((e,t)=>e+t),0)/d.length,e.removeEventListener("seeked",u),e.muted=!1,e.pause(),a(s);const f=Math.abs(m.mediaTime-o),g=f/(m.presentedFrames-l);g&&g<1&&!c&&1===e.playbackRate&&document.hasFocus()&&(r+=f,n.value+=20*f,d.push(1/g)),c=!1,o=m.mediaTime,l=m.presentedFrames,i[t]=e.requestVideoFrameCallback(y)})),n.value=0,e.play()}))}(f,c,e.querySelector("progress")),e.style.display="none"}const b=(s[c][o]??p)/p;r=m(s[c][n],u,b);const w=URL.createObjectURL(new Blob([r],{type:"text/vtt"}));let v=document.querySelector(`[id="trackId${l+c}"]`);v||(v=document.createElement("track"),v.id=`trackId${l+c}`,v.kind="captions",v.label="SubEase",v.srclang=y,v.default=!0,v.addEventListener("load",(function(){v.track.mode="showing"})),f.prepend(v)),v.src&&URL.revokeObjectURL(v.src),v.src=w,v.track.mode="showing";const I=document.querySelector(`[id="settingsIframeId${l+c}"]`);I&&I.contentWindow.postMessage({type:"trackAdded"},"*"),g(x,"Subtitles added successfully")}"closeSearchSubtitles"===x.type&&h(x,!0)}if("settingsIframe"===p.name)if("selectSubtitles"===x.type){const{id:e,videoIndex:t}=x;if(e!==d||!s[t])return;document.querySelector(`[id='settingsIframeId${e+t}']`).style.display="none",f(x)}else if("syncSubtitles"===x.type){const{id:e,videoIndex:t,syncValue:o}=x;if(e!==d||!s[t])return;c[t]=o;const l=document.querySelector(`[id="trackId${e+t}"]`);if(!l||!s[t][n])return void g(x,"Subtitles are not loaded yet",!0);const i=m(s[t][n],o),r=URL.createObjectURL(new Blob([i],{type:"text/vtt"}));URL.revokeObjectURL(l.src),l.src=r,g(x,"Synchronized successfully")}else if("enableSubtitles"===x.type){const{id:e,videoIndex:t,enable:n}=x;if(e!==d||!s[t])return;const o=document.querySelector(`[id="trackId${e+t}"]`);o&&(n?(o.track.mode="showing",g(x,"Subtitles are enabled")):(o.track.mode="hidden",g(x,"Subtitles are disabled")))}else if("changeBgColor"===x.type){const{id:e,videoIndex:n,color:o}=x;if(e!==d||!s[n])return;s[n][t].style.setProperty("--track-bg-color",o)}else if("changeTextColor"===x.type){const{id:e,videoIndex:n,color:o}=x;if(e!==d||!s[n])return;s[n][t].style.setProperty("--track-text-color",o)}else if("download"===x.type){const{id:e,videoIndex:n}=x;if(e!==d||!s[n])return;const o=s[n][t];location.href=o.src}})),p.onDisconnect.addListener((()=>{if("subtitles"===p.name)for(let e=0;e<Object.keys(s).length;e++){let t=document.querySelector(`[id="${d+e}"]`);t&&(t.style.backgroundColor="transparent")}}))}))})();